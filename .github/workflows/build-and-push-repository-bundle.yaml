name: Build TKG repository bundle
on: [push]
jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set Matrix
        id: set-matrix
        env:
          PACKAGE_REPOSITORY: "tkgrepo"
        run: |
          make $(realpath hack/tools/bin/yq)
          matrix=$(hack/tools/bin/yq e -j '.tkgrepoPackageRepository.packages.[] | {"package-name": .name, "package-path": .path} | [.] | {"include": .}' packages/package-values.yaml)
          echo "::set-output name=matrix::${matrix}"

  check-matrix:
    runs-on: ubuntu-latest
    needs: matrix
    steps:
      - name: Install json2yaml
        run: |
          sudo npm install -g json2yaml

      - name: Check matrix definition
        run: |
          matrix='${{ needs.matrix.outputs.matrix }}'
          echo $matrix
          echo $matrix | jq .
          echo $matrix | json2yaml

  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build and publish TKG repository bundle
        run: make docker-build-package-repo-bundle-dind
        env:
          PACKAGE_REPOSITORY: "tkgrepo"
          PACKAGE_VALUES_FILE: "packages/package-values.yaml"
          REGISTRY_SERVER: ${{ secrets.REGISTRY_SERVER }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          OCI_REGISTRY: ${{ secrets.OCI_REGISTRY }}
